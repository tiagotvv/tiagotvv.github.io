<!DOCTYPE html>
<html>
<body>

<p>Simulating the next legislative election in Portugal</p>

<script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>

<script>

var districts = [["Nacional",[	29.5,	32.38,	9.0,	10.22,	8.27,	1.39], 230],
["Aveiro",[	37.3,	27.9,	10.8,	9.6,	4.4,	1], 16],
["Beja",[	15.4,	37.3,	4.7,	8.2,	25,	0.8], 3],
["Braga",[	36.2,	30.9,	9.4,	8.8,	5.2,	0.8], 19],
["Bragança",[	40.6,	34.1,	8.7,	5.5,	3.1,	0.6], 3],
["Castelo Branco",[	28.2,	38.9,	7.1,	10,	6,	0.8], 4],
["Coimbra",[	29.9,	35.3,	7.3,	9.9,	7,	1], 9],
["Évora",[	18.2,	37.5,	5.8,	8.6,	21.9,	0.9], 3],
["Faro",[	23.5,	32.8,	8.0,	14.1,	8.7,	2], 9],
["Guarda",[	36.7,	33.8,	8.9,	7.4,	4,	0.9], 4],
["Leiria",[	38.0,	24.8,	10.4,	9.7,	5.1,	1.2], 10],
["Lisboa",[	24.7,	33.5,	10.0,	10.9,	9.8,	2], 47],
["Portalegre",[	21.0,	42.4,	6.6,	9.2,	12.2,	0.8], 2],
["Porto",[	31.5,	32.7,	8.1,	11.1,	6.8,	1.6], 39],
["Santarém",[	27.0,	32.9,	8.8,	10.8,	9.6,	1.2], 9],
["Setúbal",[	15.3,	34.3,	7.3,	13.1,	18.8,	1.9], 18],
["Viana do Castelo",[	34.8,	29.8,	10.7,	8,	5.2,	0.9], 6],
["Vila Real",[	43.6,	33.1,	7.4,	5.2,	3,	0.6], 5],
["Viseu",[	40.7,	29.7,	10.4,	6.7,	3.5,	0.7], 9],
["Açores",[	36.1,	40.4,	3.9,	7.8,	2.5,	0.9], 5],
["Madeira",[	37.8,	20.9,	6.0,	10.7,	3.6,	1.8], 6],
["Abroad - Europe",[	33.0,	29.9,	6.1,	5.8,	5.9,	0.9], 2],
["Abroad - Rest of the world",[45.1,	10.8,	3.4,	1.6,	1.5,	1.8], 2]];


function dHondt(votes, seats)
{
   var num_parties = votes.length;
   var allocation = [];
   var quotient = [];
   for (var i = 0; i < votes.length; i++)
   {
      quotient[i] = votes[i];
      allocation[i] = 0;
   }
   while (seats>0){
      var idx = indexOfMax(quotient);
      allocation[idx] = allocation[idx] + 1;
      quotient[idx] = votes[idx]/(allocation[idx]+1);
      seats--;
      }
  return allocation;
}

function indexOfMax(arr)
{
    if (arr.length === 0)
    {
        return -1;
    }

    var max = arr[0];
    var maxIndex = 0;

    for (var i = 1; i < arr.length; i++) {
        if (arr[i] > max) {
            maxIndex = i;
            max = arr[i];
        }
    }

    return maxIndex;
}

function sumVotes(votes)
{
  var sum = 0;
  for (var i=0; i < votes.length; i++)
  {
    sum += votes[i];
  }
  if (sum > 100)
  {
    alert("Sum = " + sum + "% (greater than 100%)");
    return false;
  }
  else if (sum < 85)
  {
    alert("Sum = " + sum + "% (less than 85%)");
    return false;
  }
  return true;
}


function countVotes()
{

  var votes = [];
  var allocation = [0,0,0,0,0,0];
  votes[0] = Number(document.getElementById('psd').value);
  votes[1] = Number(document.getElementById('ps').value);
  votes[2] = Number(document.getElementById('cds').value);
  votes[3] = Number(document.getElementById('be').value);
  votes[4] = Number(document.getElementById('pcp').value);
  votes[5] = Number(document.getElementById('pan').value);
  if(sumVotes(votes))
  {
    for(var j=1; j < (districts.length);j++)
    {
      var swing = [];
      var seats = districts[j][2];
      for(var k=0; k < votes.length; k++)
      {
        swing[k] = Math.max(districts[j][1][k] + votes[k]-districts[0][1][k],0);
      }
      var alloc = dHondt(swing,seats);
      allocation = add(allocation,alloc);

    }

  var parties = ["PSD","PS","CDS-PP","BE","PCP-PEV","PAN"];
  text = [];
  for (var i=0; i<allocation.length; i++)
  {
    text += "<li>" + parties[i] + ": " + allocation[i] + "</li> <br>";

  }
    document.getElementById("results").innerHTML = text;

  }

  /* var data = allocation;

  var width = 420,
      barHeight = 20;

  var x = d3.scale.linear()
      .domain([0, d3.max(data)+30])
      .range([0, width]);

  var chart = d3.select(".chart")
      .attr("width", width)
      .attr("height", barHeight * data.length);

  var bar = chart.selectAll("g")
      .data(data)
    .enter().append("g")
      .attr("transform", function(d, i) { return "translate(0," + i * barHeight + ")"; });

  bar.append("rect")
      .attr("width", x)
      .attr("height", barHeight - 1);

  bar.append("text")
      .attr("x", function(d) { return x(d) + 20; })
      .attr("y", barHeight / 2)
      .attr("dy", ".35em")
      .text(function(d) { return d; }); */


}

function add(a, b)
{
  var sum = [];
  if (a.length = b.length)
  {
    for (var i=0; i<a.length; i++)
    sum.push(a[i] + b[i]);
  }
  return sum;
}


</script>

<p id="demo"></p>

<!-- <div align="justify">PSD:   <input id="psd" name="user" size="5" type="text" value="0" />%<br />
PS:    <input id="ps" name="user" size="5" type="text" value="0" />%<br />
CDS:   <input id="cds" name="user" size="5" type="text" value="0" />% <br />
BE:    <input id="be" name="user" size="5" type="text" value="0" />% <br />
PCP:   <input id="pcp" name="user" size="5" type="text" value="0" />% <br />
PAN:   <input id="pan" name="user" size="5" type="text" value="0" />% <br />
<br>
<input onclick="countVotes()" type="submit" value="Get seat allocation" />
<br />
<p> -->

<table border="0" style="width:15%">
    <tr>
      <td>PSD</td>
      <td> <input id="psd" name="user" size="5" type="text" value="0" />%<br /> </td>
    </tr>
    <tr>
      <td>PS</td>
      <td> <input id="ps" name="user" size="5" type="text" value="0" />%<br /></td>
    </tr>
    <tr>
      <td>CDS-PP</td>
      <td> <input id="cds" name="user" size="5" type="text" value="0" />%<br /></td>
    </tr>
    <tr>
      <td>BE</td>
      <td> <input id="be" name="user" size="5" type="text" value="0" />%<br /></td>
    </tr>
    <tr>
      <td>PCP-PEV</td>
      <td> <input id="pcp" name="user" size="5" type="text" value="0" />%<br /></td>
    </tr>
    <tr>
      <td>PAN</td>
      <td> <input id="pan" name="user" size="5" type="text" value="0" />%<br /></td>
    </tr>
</table>
<p>

<br>
<input onclick="countVotes()" type="submit" value="Get seat allocation" />
<br />
<p>



<label id="results"> </label>

<style>

.chart rect {
  fill: steelblue;
}

.chart text {
  fill: black;
  font: 10px sans-serif;
  text-anchor: end;
}

</style>
<svg class="chart"></svg>





<br />

<p>





</body>
</html>
